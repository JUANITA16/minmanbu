Parameters:
  stage:
    Type: String
    Default: dev
    AllowedValues:
      - pdn
      - uat
      - qa
      - dev
  project:
    Type: String
  appName:
    Type: String
  serviceName:
    Type: String
Resources:
  ImageRepository:
    Type: AWS::ECR::Repository
    Properties: 
      EncryptionConfiguration: 
        EncryptionType: KMS
      ImageScanningConfiguration: 
        ScanOnPush: True
      ImageTagMutability: MUTABLE
      RepositoryName: !Sub 'ecr-${project}-${appName}-${serviceName}-${stage}'
      Tags:
        - Key: Name
          Value: !Sub 'ecr-${project}-${appName}-${serviceName}-${stage}'

  ImageVersionSecret:
    Type: 'AWS::SecretsManager::Secret'
    Properties:
      Name: !Sub 'scm-${project}-${appName}-${serviceName}-${stage}-version'
      Description: !Sub 'Deployed version for image ecr-${project}-${appName}-${serviceName}-${stage}'
      SecretString: '{"version":"latest"}'
      Tags:
        - Key: Name
          Value: !Sub 'scm-${project}-${appName}-${serviceName}-${stage}-version'
Outputs:
  imageRepositoryName:
    Description: Image Repository Name
    Value: !Ref ImageRepository
    Export:
      Name: !Sub '${AWS::StackName}-imageRepositoryName'
  imageRepositoryURI:
    Description: Image Repository URI
    Value: !GetAtt ImageRepository.RepositoryUri
    Export:
      Name: !Sub '${AWS::StackName}-imageRepositoryURI'
  imageRepositoryARN:
    Description: Image Repository ARN
    Value: !GetAtt ImageRepository.Arn
    Export:
      Name: !Sub '${AWS::StackName}-imageRepositoryARN'
  imageVersionSecretARN:
    Description: Image Version Secret ARN
    Value: !Ref ImageVersionSecret
    Export:
      Name: !Sub '${AWS::StackName}-imageVersionSecretARN'
  imageVersionSecretName:
    Description: Image Version Secret Name
    Value: !Sub 'scm-${project}-${appName}-${serviceName}-${stage}-version'
    Export:
      Name: !Sub '${AWS::StackName}-imageVersionSecretName'